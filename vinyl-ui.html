<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>VINYL FILTER â€” Teensy DSP</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,700;1,400&family=Special+Elite&family=Courier+Prime:wght@400;700&display=swap" rel="stylesheet">
<style>
  :root {
    --cream: #f2e8d5;
    --parchment: #e8d9b8;
    --amber: #c8832a;
    --dark-amber: #8b5a1a;
    --mahogany: #2a1505;
    --vinyl-black: #0d0a08;
    --vinyl-groove: #1a1510;
    --gold: #d4a843;
    --gold-light: #f0c860;
    --red: #8b2020;
    --green-active: #4a8a3c;
    --warm-shadow: rgba(42,21,5,0.6);
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    background: var(--mahogany);
    font-family: 'Courier Prime', monospace;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    overflow: hidden;
    position: relative;
  }

  /* Texture de fond bois */
  body::before {
    content: '';
    position: fixed; inset: 0;
    background-image:
      repeating-linear-gradient(
        92deg,
        transparent 0px, transparent 3px,
        rgba(255,200,100,0.018) 3px, rgba(255,200,100,0.018) 4px
      ),
      repeating-linear-gradient(
        180deg,
        transparent 0px, transparent 12px,
        rgba(0,0,0,0.06) 12px, rgba(0,0,0,0.06) 13px
      );
    pointer-events: none;
    z-index: 0;
  }

  /* Grain overlay */
  body::after {
    content: '';
    position: fixed; inset: 0;
    background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.08'/%3E%3C/svg%3E");
    opacity: 0.35;
    pointer-events: none;
    z-index: 0;
  }

  .machine {
    position: relative;
    z-index: 1;
    width: 820px;
    background: linear-gradient(165deg, #3d1f08 0%, #2a1505 40%, #1e0e02 100%);
    border-radius: 18px;
    border: 3px solid var(--dark-amber);
    padding: 40px 50px 48px;
    box-shadow:
      0 0 0 1px rgba(212,168,67,0.15),
      0 20px 80px rgba(0,0,0,0.8),
      inset 0 1px 0 rgba(240,200,96,0.2),
      inset 0 -2px 0 rgba(0,0,0,0.5);
  }

  /* Bordure dorÃ©e dÃ©corative */
  .machine::before {
    content: '';
    position: absolute;
    inset: 8px;
    border: 1px solid rgba(212,168,67,0.12);
    border-radius: 12px;
    pointer-events: none;
  }

  /* Header */
  .header {
    text-align: center;
    margin-bottom: 36px;
    position: relative;
  }

  .brand-line {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 18px;
    margin-bottom: 6px;
  }

  .brand-line::before, .brand-line::after {
    content: '';
    flex: 1;
    height: 1px;
    background: linear-gradient(to right, transparent, var(--gold), transparent);
  }

  .brand-ornament {
    color: var(--gold);
    font-size: 12px;
    letter-spacing: 4px;
  }

  h1 {
    font-family: 'Playfair Display', serif;
    font-size: 42px;
    font-weight: 700;
    color: var(--cream);
    letter-spacing: 6px;
    text-transform: uppercase;
    line-height: 1;
    text-shadow: 0 0 40px rgba(212,168,67,0.3), 0 2px 4px rgba(0,0,0,0.8);
  }

  .subtitle {
    font-family: 'Special Elite', cursive;
    font-size: 11px;
    color: var(--amber);
    letter-spacing: 8px;
    text-transform: uppercase;
    margin-top: 6px;
  }

  /* Zone principale */
  .main-section {
    display: grid;
    grid-template-columns: 1fr 340px 1fr;
    gap: 30px;
    align-items: center;
  }

  /* ===== VINYLE SVG ===== */
  .vinyl-stage {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 20px;
    grid-column: 2;
  }

  .vinyl-wrapper {
    position: relative;
    width: 300px;
    height: 300px;
  }

  /* Ombre portÃ©e du vinyle */
  .vinyl-shadow {
    position: absolute;
    inset: -10px;
    border-radius: 50%;
    background: transparent;
    box-shadow: 0 20px 60px rgba(0,0,0,0.9), 0 0 0 1px rgba(212,168,67,0.05);
    pointer-events: none;
  }

  svg.vinyl {
    width: 300px;
    height: 300px;
    border-radius: 50%;
    transition: filter 0.5s ease;
  }

  svg.vinyl.playing {
    animation: spin 1.8s linear infinite;
    filter: drop-shadow(0 0 25px rgba(212,168,67,0.2));
  }

  @keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
  }

  /* Bras de lecture */
  .tonearm {
    position: absolute;
    top: 14px;
    right: -10px;
    width: 130px;
    height: 130px;
    pointer-events: none;
    transform-origin: 90% 10%;
    transition: transform 0.8s cubic-bezier(0.4, 0, 0.2, 1);
  }

  .tonearm.playing {
    transform: rotate(-14deg);
  }

  /* LED status */
  .vinyl-status {
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .status-led {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    background: #2a1010;
    border: 1px solid #3a1515;
    transition: all 0.3s ease;
    box-shadow: none;
  }

  .status-led.active {
    background: #6abf5a;
    border-color: #88d870;
    box-shadow: 0 0 8px #6abf5a, 0 0 20px rgba(106,191,90,0.4);
    animation: pulse-led 2s ease-in-out infinite;
  }

  @keyframes pulse-led {
    0%, 100% { box-shadow: 0 0 8px #6abf5a, 0 0 20px rgba(106,191,90,0.4); }
    50% { box-shadow: 0 0 12px #6abf5a, 0 0 30px rgba(106,191,90,0.6); }
  }

  .status-text {
    font-family: 'Special Elite', cursive;
    font-size: 11px;
    letter-spacing: 3px;
    color: var(--amber);
    text-transform: uppercase;
    transition: color 0.3s;
  }

  .status-text.active { color: #88d870; }

  /* ===== CONTRÃ”LES GAUCHE / DROITE ===== */
  .controls-left, .controls-right {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 36px;
  }

  /* Boutons */
  .panel-button {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 10px;
  }

  .btn {
    width: 64px;
    height: 64px;
    border-radius: 50%;
    border: none;
    cursor: pointer;
    position: relative;
    transition: all 0.15s ease;
    outline: none;
  }

  .btn-vinyl {
    background: radial-gradient(circle at 40% 35%, #4a2010, #2a1008);
    box-shadow:
      0 6px 0 #1a0803,
      0 8px 16px rgba(0,0,0,0.7),
      inset 0 1px 0 rgba(255,180,80,0.15);
    border: 2px solid var(--dark-amber);
    cursor: default;
    pointer-events: none;
  }

  .btn-vinyl.active {
    background: radial-gradient(circle at 40% 35%, #5a2810, #3a1808);
    border-color: var(--gold);
    box-shadow:
      0 6px 0 #1a0803,
      0 8px 20px rgba(0,0,0,0.7),
      0 0 20px rgba(212,168,67,0.3),
      inset 0 1px 0 rgba(255,200,80,0.3);
  }

  .btn-icon {
    font-size: 24px;
    line-height: 1;
    transition: transform 0.2s;
  }

  .btn-vinyl.active .btn-icon { transform: scale(1.1); }

  .btn-type {
    background: radial-gradient(circle at 40% 35%, #2a2018, #181208);
    box-shadow: 0 4px 0 #0a0804, 0 6px 12px rgba(0,0,0,0.7), inset 0 1px 0 rgba(255,180,80,0.1);
    border: 2px solid #3a2818;
    width: 52px;
    height: 52px;
    cursor: default;
    pointer-events: none;
  }

  .btn-label {
    font-family: 'Special Elite', cursive;
    font-size: 10px;
    letter-spacing: 2px;
    color: var(--amber);
    text-transform: uppercase;
    text-align: center;
  }

  /* Type badge */
  .type-badge {
    display: flex;
    gap: 6px;
  }

  .type-pill {
    font-family: 'Courier Prime', monospace;
    font-size: 10px;
    font-weight: 700;
    padding: 3px 8px;
    border-radius: 10px;
    border: 1px solid #3a2818;
    color: #5a4030;
    background: transparent;
    transition: all 0.3s;
    letter-spacing: 1px;
  }

  .type-pill.active {
    border-color: var(--gold);
    color: var(--gold-light);
    background: rgba(212,168,67,0.1);
    box-shadow: 0 0 8px rgba(212,168,67,0.2);
  }

  /* ===== KNOB ===== */
  .knob-section {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 12px;
  }

  .knob-label {
    font-family: 'Special Elite', cursive;
    font-size: 10px;
    letter-spacing: 3px;
    color: var(--amber);
    text-transform: uppercase;
    text-align: center;
  }

  .knob-container {
    position: relative;
    width: 90px;
    height: 90px;
  }

  .knob-track {
    position: absolute;
    inset: 0;
  }

  .knob-body {
    position: absolute;
    inset: 14px;
    border-radius: 50%;
    background: radial-gradient(circle at 38% 32%, #2e2010, #120a02);
    border: 2px solid #2a1808;
    box-shadow:
      0 4px 12px rgba(0,0,0,0.8),
      inset 0 1px 0 rgba(255,160,60,0.12),
      inset 0 -1px 2px rgba(0,0,0,0.6);
  }

  .knob-indicator {
    position: absolute;
    inset: 18px;
    border-radius: 50%;
    display: flex;
    align-items: flex-start;
    justify-content: center;
    padding-top: 4px;
    transform-origin: center center;
    pointer-events: none;
  }

  .knob-dot {
    width: 5px;
    height: 5px;
    border-radius: 50%;
    background: var(--gold-light);
    box-shadow: 0 0 6px var(--gold), 0 0 12px rgba(240,200,96,0.5);
  }

  .knob-value {
    position: absolute;
    bottom: -2px;
    left: 50%;
    transform: translateX(-50%);
    font-family: 'Courier Prime', monospace;
    font-size: 9px;
    color: var(--gold);
    letter-spacing: 1px;
    font-weight: 700;
    white-space: nowrap;
  }

  /* ===== VU MÃˆTRE ===== */
  .vu-section {
    width: 100%;
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  .vu-label {
    font-family: 'Special Elite', cursive;
    font-size: 9px;
    letter-spacing: 3px;
    color: var(--amber);
    text-transform: uppercase;
  }

  .vu-meter {
    display: flex;
    gap: 2px;
    align-items: flex-end;
    height: 30px;
  }

  .vu-bar {
    flex: 1;
    height: 100%;
    border-radius: 1px;
    background: #1a1008;
    position: relative;
    overflow: hidden;
  }

  .vu-fill {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    background: linear-gradient(to top, #4a8a3c, #88c840, #d4a843);
    transition: height 0.08s ease;
    border-radius: 1px;
  }

  /* ===== SERIAL CONNECTION ===== */
  .serial-section {
    grid-column: 1 / -1;
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-top: 28px;
    padding-top: 24px;
    border-top: 1px solid rgba(212,168,67,0.12);
  }

  .serial-info {
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .serial-dot {
    width: 7px; height: 7px;
    border-radius: 50%;
    background: #3a1010;
    border: 1px solid #4a1818;
    transition: all 0.3s;
  }

  .serial-dot.connected {
    background: var(--gold);
    border-color: var(--gold-light);
    box-shadow: 0 0 6px var(--gold);
  }

  .serial-text {
    font-family: 'Courier Prime', monospace;
    font-size: 10px;
    color: #6a4828;
    letter-spacing: 2px;
    text-transform: uppercase;
    transition: color 0.3s;
  }

  .serial-text.connected { color: var(--amber); }

  .btn-connect {
    font-family: 'Special Elite', cursive;
    font-size: 10px;
    letter-spacing: 3px;
    text-transform: uppercase;
    color: var(--amber);
    background: transparent;
    border: 1px solid var(--dark-amber);
    padding: 8px 16px;
    border-radius: 3px;
    cursor: pointer;
    transition: all 0.2s;
  }

  .btn-connect:hover {
    border-color: var(--gold);
    color: var(--gold-light);
    background: rgba(212,168,67,0.05);
  }

  /* Log */
  .log-line {
    font-family: 'Courier Prime', monospace;
    font-size: 9px;
    color: #4a3020;
    letter-spacing: 1px;
    max-width: 300px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  /* Crackle particles */
  .particles {
    position: absolute;
    inset: 0;
    pointer-events: none;
    overflow: hidden;
    border-radius: 50%;
  }

  @keyframes crackle {
    0% { opacity: 0; transform: scale(0) translate(0,0); }
    30% { opacity: 1; }
    100% { opacity: 0; transform: scale(1.5) translate(var(--dx), var(--dy)); }
  }

  .particle {
    position: absolute;
    width: 2px; height: 2px;
    border-radius: 50%;
    background: var(--gold-light);
    top: 50%; left: 50%;
    animation: crackle 0.5s ease-out forwards;
  }

  /* Ampoule vintage dÃ©corative */
  .deco-bulbs {
    position: absolute;
    top: 18px; left: 50%;
    transform: translateX(-50%);
    display: flex;
    gap: 12px;
  }

  .bulb {
    width: 6px; height: 6px;
    border-radius: 50%;
    background: #2a1808;
    border: 1px solid #3a2010;
    transition: all 0.4s;
  }

  .bulb.on {
    background: var(--gold-light);
    border-color: var(--gold);
    box-shadow: 0 0 8px var(--gold), 0 0 16px rgba(240,200,96,0.3);
  }

  /* Stamper text on vinyl */
  .vinyl-info {
    text-align: center;
    font-family: 'Special Elite', cursive;
    font-size: 9px;
    color: #4a3020;
    letter-spacing: 2px;
    line-height: 1.8;
    margin-top: -4px;
  }
</style>
</head>
<body>

<div class="machine">

  <!-- Ampoules dÃ©co -->
  <div class="deco-bulbs" id="bulbs">
    <div class="bulb"></div>
    <div class="bulb"></div>
    <div class="bulb"></div>
    <div class="bulb"></div>
    <div class="bulb"></div>
  </div>

  <!-- Header -->
  <div class="header">
    <div class="brand-line">
      <span class="brand-ornament">âœ¦ âœ¦ âœ¦</span>
    </div>
    <h1>VINYL FILTER</h1>
    <div class="subtitle">Teensy DSP Audio Processor</div>
  </div>

  <!-- Contenu principal -->
  <div class="main-section">

    <!-- ContrÃ´les gauche -->
    <div class="controls-left">

      <!-- Bouton ON/OFF Vinyl -->
      <div class="panel-button">
        <button class="btn btn-vinyl" id="btnVinyl">
          <span class="btn-icon">ðŸ’¿</span>
        </button>
        <div class="btn-label">Vinyl Mode</div>
        <div class="vinyl-status">
          <div class="status-led" id="statusLed"></div>
          <div class="status-text" id="statusText">OFF</div>
        </div>
      </div>

      <!-- Knob IntensitÃ© -->
      <div class="knob-section">
        <div class="knob-label">IntensitÃ©</div>
        <div class="knob-container" id="knobIntensity">
          <svg class="knob-track" viewBox="0 0 90 90">
            <circle cx="45" cy="45" r="34" fill="none" stroke="#2a1808" stroke-width="3"/>
            <path id="arcIntensity" d="" fill="none" stroke="var(--gold)" stroke-width="3" stroke-linecap="round"/>
            <!-- Ticks -->
            <g id="ticksIntensity"></g>
          </svg>
          <div class="knob-body"></div>
          <div class="knob-indicator" id="indicatorIntensity">
            <div class="knob-dot"></div>
          </div>
          <div class="knob-value" id="valIntensity">0%</div>
        </div>
      </div>

      <!-- VU-mÃ¨tre intensitÃ© -->
      <div class="vu-section">
        <div class="vu-label">Effect Level</div>
        <div class="vu-meter" id="vuIntensity">
        </div>
      </div>

    </div>

    <!-- Centre : Vinyle -->
    <div class="vinyl-stage">
      <div class="vinyl-wrapper">
        <div class="vinyl-shadow"></div>

        <!-- Vinyle SVG -->
        <svg class="vinyl" id="vinylDisc" viewBox="0 0 300 300">
          <defs>
            <radialGradient id="vinylGrad" cx="50%" cy="50%" r="50%">
              <stop offset="0%" stop-color="#151010"/>
              <stop offset="30%" stop-color="#0d0a08"/>
              <stop offset="100%" stop-color="#1a1512"/>
            </radialGradient>
            <radialGradient id="labelGrad" cx="40%" cy="35%" r="60%">
              <stop offset="0%" stop-color="#8b2a18"/>
              <stop offset="60%" stop-color="#5a1a0a"/>
              <stop offset="100%" stop-color="#3a0e04"/>
            </radialGradient>
            <radialGradient id="shineGrad" cx="30%" cy="25%" r="70%">
              <stop offset="0%" stop-color="rgba(255,220,150,0.12)"/>
              <stop offset="100%" stop-color="rgba(255,220,150,0)"/>
            </radialGradient>
          </defs>

          <!-- Corps du vinyle -->
          <circle cx="150" cy="150" r="148" fill="url(#vinylGrad)"/>

          <!-- Sillons (cercles concentriques) -->
          <g opacity="0.35">
            <circle cx="150" cy="150" r="140" fill="none" stroke="#2a2018" stroke-width="0.5"/>
            <circle cx="150" cy="150" r="133" fill="none" stroke="#1e160e" stroke-width="0.8"/>
            <circle cx="150" cy="150" r="126" fill="none" stroke="#2a2018" stroke-width="0.5"/>
            <circle cx="150" cy="150" r="118" fill="none" stroke="#1e160e" stroke-width="0.6"/>
            <circle cx="150" cy="150" r="110" fill="none" stroke="#2a2018" stroke-width="0.5"/>
            <circle cx="150" cy="150" r="102" fill="none" stroke="#1e160e" stroke-width="0.7"/>
            <circle cx="150" cy="150" r="95" fill="none" stroke="#2a2018" stroke-width="0.5"/>
            <circle cx="150" cy="150" r="88" fill="none" stroke="#1e160e" stroke-width="0.6"/>
            <circle cx="150" cy="150" r="81" fill="none" stroke="#2a2018" stroke-width="0.5"/>
          </g>

          <!-- Reflet -->
          <circle cx="150" cy="150" r="148" fill="url(#shineGrad)"/>

          <!-- Ã‰tiquette centrale -->
          <circle cx="150" cy="150" r="55" fill="url(#labelGrad)"/>

          <!-- Ornements sur l'Ã©tiquette -->
          <circle cx="150" cy="150" r="52" fill="none" stroke="rgba(212,168,67,0.25)" stroke-width="0.8"/>
          <circle cx="150" cy="150" r="46" fill="none" stroke="rgba(212,168,67,0.12)" stroke-width="0.5"/>

          <!-- Texte Ã©tiquette -->
          <text x="150" y="138" text-anchor="middle" font-family="Playfair Display, serif" font-size="7" fill="rgba(240,200,96,0.8)" letter-spacing="3" font-style="italic">DSP</text>
          <text x="150" y="150" text-anchor="middle" font-family="Special Elite, cursive" font-size="8.5" fill="rgba(240,200,96,0.9)" letter-spacing="2">VINYL</text>
          <text x="150" y="162" text-anchor="middle" font-family="Courier Prime, monospace" font-size="5.5" fill="rgba(200,131,42,0.7)" letter-spacing="1.5">FILTER</text>

          <!-- Type affichÃ© sur l'Ã©tiquette -->
          <text id="typeLabel" x="150" y="177" text-anchor="middle" font-family="Courier Prime, monospace" font-size="7" fill="rgba(200,131,42,0.5)" letter-spacing="2">78 RPM</text>

          <!-- Trou central -->
          <circle cx="150" cy="150" r="6" fill="var(--mahogany)"/>
          <circle cx="150" cy="150" r="4" fill="#0d0a08"/>

          <!-- Reflet brillant sillon -->
          <ellipse cx="90" cy="80" rx="30" ry="15" fill="rgba(255,220,150,0.04)" transform="rotate(-30, 90, 80)"/>
        </svg>

        <!-- Bras de lecture -->
        <svg class="tonearm" id="tonearm" viewBox="0 0 130 130">
          <!-- Pivot -->
          <circle cx="115" cy="12" r="10" fill="radial-gradient(circle, #3a2010, #1a0a02)" stroke="var(--dark-amber)" stroke-width="1.5"/>
          <circle cx="115" cy="12" r="6" fill="#2a1808"/>
          <circle cx="115" cy="12" r="3" fill="#3a2010"/>
          <!-- Bras -->
          <line x1="115" y1="12" x2="50" y2="90" stroke="#c8832a" stroke-width="4" stroke-linecap="round"/>
          <line x1="50" y1="90" x2="30" y2="105" stroke="#b07020" stroke-width="3" stroke-linecap="round"/>
          <!-- TÃªte de lecture -->
          <rect x="18" y="100" width="20" height="12" rx="2" fill="#2a1808" stroke="var(--gold)" stroke-width="1"/>
          <circle cx="28" cy="118" r="3" fill="var(--gold)" opacity="0.8"/>
        </svg>

        <!-- Particules craquements -->
        <div class="particles" id="particles"></div>
      </div>

      <div class="vinyl-info" id="vinylInfo">
        <span id="typeDisplay">78 RPM â€¢ Standard</span>
      </div>
    </div>

    <!-- ContrÃ´les droite -->
    <div class="controls-right">

      <!-- Bouton type -->
      <div class="panel-button">
        <button class="btn btn-type" id="btnType">
          <span class="btn-icon" style="font-size:18px">ðŸ”„</span>
        </button>
        <div class="btn-label">Vinyl Type</div>
        <div class="type-badge">
          <div class="type-pill active" id="pill78">78 RPM</div>
          <div class="type-pill" id="pill33">33 RPM</div>
        </div>
      </div>

      <!-- Knob Volume -->
      <div class="knob-section">
        <div class="knob-label">Volume</div>
        <div class="knob-container" id="knobVolume">
          <svg class="knob-track" viewBox="0 0 90 90">
            <circle cx="45" cy="45" r="34" fill="none" stroke="#2a1808" stroke-width="3"/>
            <path id="arcVolume" d="" fill="none" stroke="var(--amber)" stroke-width="3" stroke-linecap="round"/>
          </svg>
          <div class="knob-body"></div>
          <div class="knob-indicator" id="indicatorVolume">
            <div class="knob-dot" style="background: var(--amber); box-shadow: 0 0 6px var(--amber);"></div>
          </div>
          <div class="knob-value" id="valVolume">0%</div>
        </div>
      </div>

      <!-- VU-mÃ¨tre volume -->
      <div class="vu-section">
        <div class="vu-label">Output Level</div>
        <div class="vu-meter" id="vuVolume">
        </div>
      </div>

    </div>

  </div>

  <!-- Section SÃ©rie -->
  <div class="serial-section">
    <div class="serial-info">
      <div class="serial-dot" id="serialDot"></div>
      <div class="serial-text" id="serialText">No device connected</div>
    </div>
    <div class="log-line" id="logLine">Waiting for serial data...</div>
    <button class="btn-connect" id="btnConnect" onclick="connectSerial()">
      Connect Serial
    </button>
  </div>

</div>

<script>
// ===============================================
// Ã‰TAT
// ===============================================
let vinylActive = false;
let vinylType = '78';
let intensity = 0;
let volume = 0;
let serialPort = null;
let serialReader = null;
let serialBuffer = '';

// ===============================================
// INIT VU METERS
// ===============================================
function initVUMeters() {
  const vuI = document.getElementById('vuIntensity');
  const vuV = document.getElementById('vuVolume');
  for (let i = 0; i < 12; i++) {
    const bar = document.createElement('div');
    bar.className = 'vu-bar';
    bar.innerHTML = '<div class="vu-fill" style="height:0%"></div>';
    vuI.appendChild(bar.cloneNode(true));
    vuV.appendChild(bar);
  }
}

// ===============================================
// UPDATE VU METER
// ===============================================
function updateVU(id, value) {
  const bars = document.querySelectorAll(`#${id} .vu-fill`);
  const count = bars.length;
  bars.forEach((bar, i) => {
    const threshold = (i / count);
    const active = value > threshold;
    const pct = active ? Math.min(100, ((value - threshold) / (1/count)) * 100) : 0;
    // Couleur selon position
    const pct_pos = i / count;
    let color;
    if (pct_pos < 0.6) color = 'linear-gradient(to top, #3a7a2e, #5ab040)';
    else if (pct_pos < 0.85) color = 'linear-gradient(to top, #c8832a, #f0b050)';
    else color = 'linear-gradient(to top, #8b2020, #cc4040)';
    bar.style.background = color;
    bar.style.height = active ? '100%' : '0%';
  });
}

// ===============================================
// KNOB ARC SVG
// ===============================================
function polarToXY(cx, cy, r, angleDeg) {
  const rad = (angleDeg - 90) * Math.PI / 180;
  return { x: cx + r * Math.cos(rad), y: cy + r * Math.sin(rad) };
}

function describeArc(cx, cy, r, startAngle, endAngle) {
  const s = polarToXY(cx, cy, r, startAngle);
  const e = polarToXY(cx, cy, r, endAngle);
  const large = endAngle - startAngle > 180 ? 1 : 0;
  return `M ${s.x} ${s.y} A ${r} ${r} 0 ${large} 1 ${e.x} ${e.y}`;
}

function updateKnob(indicatorId, arcId, valId, value) {
  // value 0..1 -> angle -140Â° Ã  +140Â°
  const minAngle = -140;
  const maxAngle = 140;
  const angle = minAngle + value * (maxAngle - minAngle);

  // Rotation de l'indicateur (le point blanc)
  document.getElementById(indicatorId).style.transform = `rotate(${angle}deg)`;

  // Arc SVG
  if (value > 0.001) {
    const path = describeArc(45, 45, 34, minAngle + 90, angle + 90);
    document.getElementById(arcId).setAttribute('d', path);
  } else {
    document.getElementById(arcId).setAttribute('d', '');
  }

  // Valeur textuelle
  document.getElementById(valId).textContent = Math.round(value * 100) + '%';
}

// ===============================================
// TOGGLE VINYL (serial only)
// ===============================================
function applyVinylState() {
  const disc = document.getElementById('vinylDisc');
  const tonearm = document.getElementById('tonearm');
  const btn = document.getElementById('btnVinyl');
  const led = document.getElementById('statusLed');
  const txt = document.getElementById('statusText');
  const bulbs = document.querySelectorAll('.bulb');

  if (vinylActive) {
    disc.classList.add('playing');
    tonearm.classList.add('playing');
    btn.classList.add('active');
    led.classList.add('active');
    txt.classList.add('active');
    txt.textContent = 'ON';
    // Ampoules
    bulbs.forEach((b, i) => {
      setTimeout(() => b.classList.add('on'), i * 80);
    });
    spawnParticles();
  } else {
    disc.classList.remove('playing');
    tonearm.classList.remove('playing');
    btn.classList.remove('active');
    led.classList.remove('active');
    txt.classList.remove('active');
    txt.textContent = 'OFF';
    bulbs.forEach(b => b.classList.remove('on'));
  }
}

// ===============================================
// TYPE (serial only)
// ===============================================
function applyTypeState() {
  const pill78 = document.getElementById('pill78');
  const pill33 = document.getElementById('pill33');
  const typeLabel = document.getElementById('typeLabel');
  const typeDisplay = document.getElementById('typeDisplay');

  if (vinylType === '78') {
    pill78.classList.add('active');
    pill33.classList.remove('active');
    typeLabel.textContent = '78 RPM';
    typeDisplay.textContent = '78 RPM â€¢ Standard';
    document.getElementById('vinylDisc').style.animationDuration = '1.8s';
  } else {
    pill33.classList.add('active');
    pill78.classList.remove('active');
    typeLabel.textContent = '33 RPM';
    typeDisplay.textContent = '33â…“ RPM â€¢ Long Play';
    document.getElementById('vinylDisc').style.animationDuration = '4.2s';
  }
}

// ===============================================
// PARTICULES CRAQUEMENTS
// ===============================================
function spawnParticles() {
  if (!vinylActive) return;
  if (Math.random() > 0.2) {
    setTimeout(spawnParticles, 100 + Math.random() * 400);
    return;
  }
  const container = document.getElementById('particles');
  const count = Math.floor(Math.random() * 4) + 2;
  for (let i = 0; i < count; i++) {
    const p = document.createElement('div');
    p.className = 'particle';
    const dx = (Math.random() - 0.5) * 60;
    const dy = (Math.random() - 0.5) * 60;
    p.style.setProperty('--dx', dx + 'px');
    p.style.setProperty('--dy', dy + 'px');
    p.style.animationDelay = (i * 30) + 'ms';
    container.appendChild(p);
    setTimeout(() => p.remove(), 700);
  }
  setTimeout(spawnParticles, 100 + Math.random() * 400);
}

// ===============================================
// SERIAL (Web Serial API)
// ===============================================
async function connectSerial() {
  if (!('serial' in navigator)) {
    alert('Web Serial API non supportÃ©.\nUtilisez Chrome ou Edge.\nActivez : chrome://flags/#enable-experimental-web-platform-features');
    return;
  }
  try {
    serialPort = await navigator.serial.requestPort();
    await serialPort.open({ baudRate: 9600 });
    document.getElementById('serialDot').classList.add('connected');
    document.getElementById('serialText').classList.add('connected');
    document.getElementById('serialText').textContent = 'Connected';
    document.getElementById('btnConnect').textContent = 'Disconnect';
    document.getElementById('btnConnect').onclick = disconnectSerial;
    readSerial();
  } catch(e) {
    console.error('Serial error:', e);
    document.getElementById('logLine').textContent = 'Connection failed: ' + e.message;
  }
}

async function disconnectSerial() {
  if (serialReader) { await serialReader.cancel(); serialReader = null; }
  if (serialPort) { await serialPort.close(); serialPort = null; }
  document.getElementById('serialDot').classList.remove('connected');
  document.getElementById('serialText').classList.remove('connected');
  document.getElementById('serialText').textContent = 'No device connected';
  document.getElementById('btnConnect').textContent = 'Connect Serial';
  document.getElementById('btnConnect').onclick = connectSerial;
}

async function readSerial() {
  const decoder = new TextDecoderStream();
  serialPort.readable.pipeTo(decoder.writable);
  const reader = decoder.readable.getReader();
  serialReader = reader;

  try {
    while (true) {
      const { value, done } = await reader.read();
      if (done) break;
      serialBuffer += value;
      processBuffer();
    }
  } catch (e) {
    console.log('Serial read ended:', e);
  }
}

function processBuffer() {
  const lines = serialBuffer.split('\n');
  serialBuffer = lines.pop(); // garder le reste incomplet

  lines.forEach(line => {
    line = line.trim();
    if (!line) return;

    document.getElementById('logLine').textContent = line;

    if (line.startsWith('[INTENSITY]')) {
      const val = parseFloat(line.replace('[INTENSITY]', ''));
      if (!isNaN(val)) {
        intensity = Math.max(0, Math.min(1, val));
        updateKnob('indicatorIntensity', 'arcIntensity', 'valIntensity', intensity);
        updateVU('vuIntensity', intensity);
      }
    } else if (line.startsWith('[VOLUME]')) {
      const val = parseFloat(line.replace('[VOLUME]', ''));
      if (!isNaN(val)) {
        volume = Math.max(0, Math.min(1, val));
        updateKnob('indicatorVolume', 'arcVolume', 'valVolume', volume);
        updateVU('vuVolume', volume);
      }
    } else if (line.includes('[VINYL] ON')) {
      vinylActive = true; applyVinylState();
    } else if (line.includes('[VINYL] OFF')) {
      vinylActive = false; applyVinylState();
    } else if (line.includes('[TYPE] 33')) {
      vinylType = '33'; applyTypeState();
    } else if (line.includes('[TYPE] 78')) {
      vinylType = '78'; applyTypeState();
    }
  });
}

// ===============================================
// INIT
// ===============================================
initVUMeters();
applyVinylState();
applyTypeState();
</script>
</body>
</html>
